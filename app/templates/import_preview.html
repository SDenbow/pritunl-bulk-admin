{% extends "base.html" %}
{% block content %}

  <div style="float:right;">
    <form method="post" action="/logout" style="display:inline;">
      <button type="submit">Logout</button>
    </form>
  </div>

  <p><a href="/targets/{{ target.id }}">‚Üê Back to Target</a></p>

  <h3>Import Preview (Read-only)</h3>

  {% if warn_msgs and (warn_msgs|length > 0) %}
    <div style="margin:12px 0;padding:10px;border:2px solid #cc8800;background:#fff7e6;">
      <b>Guardrail Warning</b>
      <ul style="margin:8px 0 0 18px;">
        {% for w in warn_msgs %}
          <li>{{ w }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if error %}<div class="error">{{ error }}</div>{% endif %}

  {% if summary %}
    <h4>Summary</h4>
    <table>
      <tr><th>Total rows</th><td>{{ summary.total_rows }}</td></tr>
      <tr><th>Actioned rows</th><td>{{ summary.actioned_rows }}</td></tr>
      <tr {% if warn and warn.creates %}style="background:#fff7e6;border-left:4px solid #cc8800;"{% endif %}><th>Creates</th><td>{{ summary.creates }}</td></tr>
      <tr><th>Updates</th><td>{{ summary.updates }}</td></tr>
      <tr {% if warn and warn.disables %}style="background:#fff7e6;border-left:4px solid #cc8800;"{% endif %}><th>Disables</th><td>{{ summary.disables }}</td></tr>
      <tr {% if warn and warn.deletes %}style="background:#fff7e6;border-left:4px solid #cc8800;"{% endif %}><th>Deletes</th><td>{{ summary.deletes }}</td></tr>
      <tr {% if warn and warn.clears %}style="background:#fff7e6;border-left:4px solid #cc8800;"{% endif %}><th>Group clears</th><td>{{ summary.clears }}</td></tr>
      <tr><th>Skips</th><td>{{ summary.skips }}</td></tr>
      <tr><th>Errors</th><td>{{ summary.errors }}</td></tr>
    </table>

    <p style="margin-top:10px;">
      <a href="/targets/{{ target.id }}/import/preview_report.csv?job={{ job_id }}">
        <button type="button">Download Preview Report (CSV)</button>
      </a>
    </p>
  {% endif %}

  {% if items %}
    <h4>Preview Items (first {{ items|length }})</h4>
    <table>
      <tr>
        <th>Row</th>
        <th>Action</th>
        <th>Email</th>
        <th>Username</th>
        <th>Status</th>
        <th>Before</th>
        <th>After</th>
        <th>Error</th>
      </tr>
      {% for it in items %}
      <tr>
        <td>{{ it.row }}</td>
        <td>{{ it.action }}</td>
        <td>{{ it.email }}</td>
        <td>{{ it.username or "" }}</td>
        <td>{{ it.status }}</td>
        <td><pre style="white-space:pre-wrap;margin:0;">{{ it.before }}</pre></td>
        <td><pre style="white-space:pre-wrap;margin:0;">{{ it.after }}</pre></td>
        <td><pre style="white-space:pre-wrap;margin:0;">{{ it.error or "" }}</pre></td>
      </tr>
      {% endfor %}
    </table>

    <h4 style="margin-top:14px;">Apply</h4>

    {% if can_apply %}
      <form method="post" action="/targets/{{ target.id }}/import/apply" style="margin-top:8px;">
        <input type="hidden" name="batch_id" value="{{ batch_id }}">
        <input type="hidden" name="preview_sha256" value="{{ preview_sha256 }}">

        <label style="display:block;margin:8px 0;">
          <input type="checkbox" name="confirm" value="yes" required>
          I understand this will make changes on the target and will be fully audited.
        </label>

        <button type="submit">Apply Changes</button>
      </form>
    {% else %}
      <button type="button" disabled title="{{ apply_disabled_reason }}">
        Apply Changes (disabled)
      </button>
    {% endif %}

  {% endif %}

  {% if apply_result %}
    <h4 style="margin-top:16px;">Apply Result</h4>
    <pre style="white-space:pre-wrap;">{{ apply_result }}</pre>
  {% endif %}

{% endblock %}
